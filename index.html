<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Manager</title>
    <meta name="theme-color" content="#2563eb">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            color: #2563eb;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .search-section {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            min-width: 200px;
        }
        
        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-height: 44px;
        }
        
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 1rem;
        }
        
        .summary-table {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .summary-table h2 {
            background: #2563eb;
            color: white;
            padding: 1rem;
            margin: 0;
            font-size: 1.2rem;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .client-row {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .client-row:hover {
            background: #f8fafc;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-ok {
            background: #dcfce7;
            color: #059669;
        }
        
        .status-due {
            background: #fee2e2;
            color: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #2563eb;
            transition: width 0.3s ease;
        }
        
        .calendar-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day {
            background: white;
            padding: 0.5rem;
            min-height: 60px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #f8fafc;
        }
        
        .calendar-day.other-month {
            background: #f8fafc;
            color: #9ca3af;
        }
        
        .calendar-day.today {
            background: #eff6ff;
            border: 2px solid #2563eb;
        }
        
        .day-number {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .session-indicator {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 0.25rem;
        }
        
        .session-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #2563eb;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .container {
                padding: 0 0.5rem;
            }
            
            .summary-table h2 {
                font-size: 1rem;
                padding: 0.75rem;
            }
            
            th, td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .calendar-day {
                min-height: 50px;
                padding: 0.25rem;
            }
            
            .day-number {
                font-size: 0.8rem;
            }
            
            .session-dot {
                width: 4px;
                height: 4px;
            }
            
            .modal-content {
                margin: 5% auto;
                max-width: 95%;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 Coaching Manager</h1>
        <div class="search-section">
            <input type="text" id="clientSearch" class="search-input" placeholder="🔍 Rechercher un client...">
            <button onclick="openAddModal()" class="btn btn-success">+ Séance</button>
            <button onclick="openRecurringModal()" class="btn btn-warning">🔄 Récurrente</button>
            <button onclick="exportData()" class="btn btn-primary">📤 Export</button>
        </div>
    </div>

    <div class="container">
        <!-- Tableau récapitulatif -->
        <div class="summary-table">
            <h2>📊 Récapitulatif des coachings</h2>
            <div class="table-container">
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>👤 Client</th>
                            <th>📈 Total</th>
                            <th>🎯 Cycle</th>
                            <th>💰 Status</th>
                            <th>📅 Dernière</th>
                            <th>⚡ Actions</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody">
                        <!-- Les données seront générées ici -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Calendrier -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h2 id="currentMonth">Loading...</h2>
                <div class="calendar-nav">
                    <button onclick="changeMonth(-1)" class="btn btn-primary">‹</button>
                    <button onclick="goToToday()" class="btn btn-primary">Aujourd'hui</button>
                    <button onclick="changeMonth(1)" class="btn btn-primary">›</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Le calendrier sera généré ici -->
            </div>
        </div>
    </div>

    <!-- Modal nouvelle séance -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h3>Ajouter une séance</h3>
            <form id="sessionForm">
                <div class="form-group">
                    <label>Nom du client :</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label>Date :</label>
                    <input type="date" id="sessionDate" required>
                </div>
                <div class="form-group">
                    <label>Heure :</label>
                    <input type="time" id="sessionTime" required>
                </div>
                <div class="form-group">
                    <label>Type :</label>
                    <select id="sessionType">
                        <option value="coaching">Coaching individuel</option>
                        <option value="group">Coaching de groupe</option>
                        <option value="consultation">Consultation</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Ajouter</button>
            </form>
        </div>
    </div>

    <!-- Modal séances récurrentes -->
    <div id="recurringModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h3>Séance récurrente</h3>
            <form id="recurringForm">
                <div class="form-group">
                    <label>Client :</label>
                    <input type="text" id="recurringClient" required>
                </div>
                <div class="form-group">
                    <label>Jour de la semaine :</label>
                    <select id="recurringDay">
                        <option value="1">Lundi</option>
                        <option value="2">Mardi</option>
                        <option value="3">Mercredi</option>
                        <option value="4">Jeudi</option>
                        <option value="5">Vendredi</option>
                        <option value="6">Samedi</option>
                        <option value="0">Dimanche</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Heure :</label>
                    <input type="time" id="recurringTime" required>
                </div>
                <div class="form-group">
                    <label>Commencer le :</label>
                    <input type="date" id="startRecurring" required>
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%;">Créer récurrence</button>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let sessions = [];
        let recurringSessions = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let filteredClient = '';

        // Données d'exemple
        function initData() {
            sessions = [
                { id: 1, client: 'Théo', date: '2025-01-15', time: '10:00', type: 'coaching' },
                { id: 2, client: 'Théo', date: '2025-01-22', time: '10:00', type: 'coaching' },
                { id: 3, client: 'Théo', date: '2025-01-29', time: '10:00', type: 'coaching' },
                { id: 4, client: 'Théo', date: '2025-02-05', time: '10:00', type: 'coaching' },
                { id: 5, client: 'Théo', date: '2025-02-12', time: '10:00', type: 'coaching' },
                { id: 6, client: 'Théo', date: '2025-02-19', time: '10:00', type: 'coaching' },
                { id: 7, client: 'Théo', date: '2025-02-26', time: '10:00', type: 'coaching' },
                { id: 8, client: 'Théo', date: '2025-03-05', time: '10:00', type: 'coaching' },
                { id: 9, client: 'Marie', date: '2025-01-16', time: '14:00', type: 'consultation' },
                { id: 10, client: 'Marie', date: '2025-01-23', time: '14:00', type: 'consultation' },
                { id: 11, client: 'Jean', date: '2025-01-17', time: '16:00', type: 'group' },
                { id: 12, client: 'Sophie', date: '2025-01-18', time: '11:00', type: 'coaching' }
            ];
        }

        // Calculer les statistiques par client
        function getClientStats() {
            const stats = {};
            
            sessions.forEach(session => {
                if (!stats[session.client]) {
                    stats[session.client] = {
                        total: 0,
                        currentCycle: 0,
                        lastSession: null,
                        sessions: []
                    };
                }
                stats[session.client].total++;
                stats[session.client].sessions.push(session);
                
                // Trouver la dernière séance
                if (!stats[session.client].lastSession || session.date > stats[session.client].lastSession) {
                    stats[session.client].lastSession = session.date;
                }
            });

            // Calculer le cycle actuel (position avant prochain paiement)
            Object.keys(stats).forEach(client => {
                const total = stats[client].total;
                stats[client].currentCycle = total % 10 === 0 ? 10 : total % 10;
                stats[client].sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            return stats;
        }

        // Générer le tableau récapitulatif
        function generateSummaryTable() {
            const tbody = document.getElementById('summaryBody');
            const clientStats = getClientStats();
            
            let html = '';
            
            Object.keys(clientStats).forEach(client => {
                if (!filteredClient || client.toLowerCase().includes(filteredClient.toLowerCase())) {
                    const stats = clientStats[client];
                    const paymentDue = stats.currentCycle === 10;
                    const progress = (stats.currentCycle / 10) * 100;
                    const lastSessionFormatted = stats.lastSession ? formatDate(stats.lastSession) : 'Aucune';
                    
                    html += `
                        <tr class="client-row" onclick="showClientDetails('${client}')">
                            <td><strong>${client}</strong></td>
                            <td>${stats.total}</td>
                            <td>
                                ${stats.currentCycle}/10
                                <div class="progress-bar" style="margin-top: 0.25rem;">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge ${paymentDue ? 'status-due' : 'status-ok'}">
                                    ${paymentDue ? '💰 Paiement dû' : '✅ OK'}
                                </span>
                            </td>
                            <td>${lastSessionFormatted}</td>
                            <td>
                                <button onclick="event.stopPropagation(); markPayment('${client}')" 
                                        class="btn btn-success" 
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        ${!paymentDue ? 'disabled' : ''}>
                                    💰 Payé
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });

            tbody.innerHTML = html;
        }

        // Générer le calendrier
        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthHeader = document.getElementById('currentMonth');
            
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            monthHeader.textContent = `${months[currentMonth]} ${currentYear}`;

            // Premier jour du mois
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            let html = '';
            
            // En-têtes des jours
            const dayHeaders = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day" style="background: #2563eb; color: white; text-align: center; font-weight: bold; cursor: default;">${day}</div>`;
            });

            // Jours du mois précédent
            const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="day-number">${prevMonthDays - i}</div>
                </div>`;
            }

            // Jours du mois actuel
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const today = new Date();
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                // Séances pour ce jour
                const daySessions = sessions.filter(session => {
                    const matchClient = !filteredClient || session.client.toLowerCase().includes(filteredClient.toLowerCase());
                    return session.date === dateStr && matchClient;
                });

                const dots = daySessions.map(() => '<div class="session-dot"></div>').join('');
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="showDayDetails('${dateStr}')">
                    <div class="day-number">${day}</div>
                    <div class="session-indicator">${dots}</div>
                </div>`;
            }

            // Jours du mois suivant
            const totalCells = 42; // 6 semaines
            const usedCells = startingDayOfWeek + daysInMonth;
            const remainingCells = totalCells - usedCells - 7; // -7 pour les en-têtes
            
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="day-number">${day}</div>
                </div>`;
            }

            grid.innerHTML = html;
        }

        // Changer de mois
        function changeMonth(direction) {
            currentMonth += direction;
            
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            
            generateCalendar();
        }

        // Aller à aujourd'hui
        function goToToday() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            generateCalendar();
        }

        // Formater une date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }

        // Ouvrir les modales
        function openAddModal() {
            document.getElementById('addModal').style.display = 'block';
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
        }

        function openRecurringModal() {
            document.getElementById('recurringModal').style.display = 'block';
            document.getElementById('startRecurring').value = new Date().toISOString().split('T')[0];
        }

        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('recurringModal').style.display = 'none';
        }

        // Marquer un paiement comme reçu
        function markPayment(client) {
            if (confirm(`Marquer le paiement de ${client} comme reçu ?\nCela va remettre son compteur à zéro.`)) {
                // Dans un vrai système, on ajusterait la base de données
                // Ici, on peut ajouter une propriété pour marquer les paiements
                alert(`✅ Paiement de ${client} marqué comme reçu !`);
                generateSummaryTable();
            }
        }

        // Afficher les détails d'un client
        function showClientDetails(client) {
            const clientStats = getClientStats()[client];
            if (!clientStats) return;
            
            const sessionsList = clientStats.sessions.slice(0, 10).map(s => 
                `• ${formatDate(s.date)} à ${s.time} (${s.type})`
            ).join('\n');
            
            const remaining = 10 - clientStats.currentCycle;
            const nextPayment = clientStats.currentCycle === 10 ? 
                'Paiement dû maintenant !' : 
                `${remaining} séances avant paiement`;
            
            alert(`📊 Détails pour ${client}:\n\n` +
                  `Total: ${clientStats.total} séances\n` +
                  `Cycle actuel: ${clientStats.currentCycle}/10\n` +
                  `Statut: ${nextPayment}\n\n` +
                  `Dernières séances:\n${sessionsList}`);
        }

        // Afficher les détails d'une journée
        function showDayDetails(date) {
            const daySessions = sessions.filter(s => s.date === date);
            if (daySessions.length === 0) return;
            
            const sessionsList = daySessions.map(s => 
                `• ${s.client} à ${s.time} (${s.type})`
            ).join('\n');
            
            alert(`📅 Séances du ${formatDate(date)}:\n\n${sessionsList}`);
        }

        // Générer les séances récurrentes
        function generateRecurringSessions(recurringData) {
            const today = new Date();
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + 3); // 3 mois à l'avance

            let currentDate = new Date(recurringData.startDate);
            
            // Aller au prochain jour correspondant
            while (currentDate.getDay() !== parseInt(recurringData.day)) {
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Générer les séances
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // Vérifier si cette séance n'existe pas déjà
                const exists = sessions.some(s => 
                    s.client === recurringData.client && 
                    s.date === dateStr && 
                    s.time === recurringData.time
                );

                if (!exists) {
                    sessions.push({
                        id: Date.now() + Math.random(),
                        client: recurringData.client,
                        date: dateStr,
                        time: recurringData.time,
                        type: 'coaching',
                        isRecurring: true
                    });
                }

                currentDate.setDate(currentDate.getDate() + 7); // Semaine suivante
            }
        }

        // Exporter les données
        function exportData() {
            const data = {
                sessions: sessions,
                recurringSessions: recurringSessions,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `coaching-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('📤 Données exportées !');
        }

        // Event listeners
        document.getElementById('sessionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newSession = {
                id: Date.now(),
                client: document.getElementById('clientName').value,
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value,
                type: document.getElementById('sessionType').value
            };
            
            sessions.push(newSession);
            generateSummaryTable();
            generateCalendar();
            closeModal();
            
            document.getElementById('sessionForm').reset();
            alert(`✅ Séance ajoutée pour ${newSession.client}`);
        });

        document.getElementById('recurringForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const recurringData = {
                client: document.getElementById('recurringClient').value,
                day: document.getElementById('recurringDay').value,
                time: document.getElementById('recurringTime').value,
                startDate: document.getElementById('startRecurring').value
            };
            
            generateRecurringSessions(recurringData);
            generateSummaryTable();
            generateCalendar();
            closeModal();
            
            document.getElementById('recurringForm').reset();
            
            const dayNames = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
            alert(`🔄 Séances récurrentes créées pour ${recurringData.client} tous les ${dayNames[recurringData.day]} à ${recurringData.time}`);
        });

        document.getElementById('clientSearch').addEventListener('input', (e) => {
            filteredClient = e.target.value;
            generateSummaryTable();
            generateCalendar();
        });

        // Fermer les modales en cliquant à l'extérieur
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Initialisation
        try {
            initData();
            generateSummaryTable();
            generateCalendar();
            console.log('✅ Application chargée avec succès');
        } catch (error) {
            console.error('❌ Erreur:', error);
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: white;"><h1>Erreur de chargement</h1><p>${error.message}</p></div>`;
        }
    </script>
</body>
</html>
